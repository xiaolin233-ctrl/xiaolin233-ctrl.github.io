<!DOCTYPE html>
<html>
<head>
    <title>网页蓝牙文件传输</title>
    <style>
        .container { max-width: 600px; margin: 20px auto; padding: 20px; }
        #status { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .connected { background: #d4edda; }
        .disconnected { background: #f8d7da; }
        progress { width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>网页蓝牙文件传输</h1>
        
        <input type="file" id="fileInput">
        <button id="connectBtn">连接设备</button>
        <button id="sendBtn" disabled>发送文件</button>
        
        <div id="status" class="disconnected">未连接</div>
        <progress id="progress" value="0" max="100" hidden></progress>
        <div id="receivedFiles"></div>
    </div>

    <script>
        const FILE_SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const FILE_CHARACTERISTIC_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        
        let device = null;
        let fileCharacteristic = null;
        let currentFile = null;

        // 初始化蓝牙连接
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [FILE_SERVICE_UUID] }],
                    optionalServices: [FILE_SERVICE_UUID]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(FILE_SERVICE_UUID);
                fileCharacteristic = await service.getCharacteristic(FILE_CHARACTERISTIC_UUID);
                
                updateStatus(`已连接到: ${device.name || '未知设备'}`);
                document.getElementById('sendBtn').disabled = false;
                setupFileReceiver();
            } catch (error) {
                updateStatus(`连接失败: ${error}`);
            }
        });

        // 文件选择处理
        document.getElementById('fileInput').addEventListener('change', (e) => {
            currentFile = e.target.files[0];
        });

        // 发送文件
        document.getElementById('sendBtn').addEventListener('click', async () => {
            if (!currentFile) return;
            
            try {
                const chunkSize = 512; // 根据设备调整分片大小
                const reader = new FileReader();
                let offset = 0;
                
                reader.onload = async (e) => {
                    const chunk = e.target.result;
                    await fileCharacteristic.writeValue(chunk);
                    offset += chunk.byteLength;
                    
                    const progress = (offset / currentFile.size * 100).toFixed(1);
                    document.getElementById('progress').value = progress;
                    
                    if (offset < currentFile.size) {
                        readNextChunk(reader, offset, chunkSize);
                    }
                };
                
                readNextChunk(reader, 0, chunkSize);
                document.getElementById('progress').hidden = false;
            } catch (error) {
                updateStatus(`发送失败: ${error}`);
            }
        });

        function readNextChunk(reader, offset, chunkSize) {
            const file = currentFile.slice(offset, offset + chunkSize);
            reader.readAsArrayBuffer(file);
        }

        // 接收文件处理
        function setupFileReceiver() {
            let receivedData = [];
            let fileSize = 0;
            
            fileCharacteristic.addEventListener('characteristicvaluechanged', event => {
                const value = event.target.value;
                
                if (fileSize === 0) { // 第一个包包含文件信息
                    const header = new TextDecoder().decode(value);
                    fileSize = parseInt(header.split(':')[1]);
                    receivedData = [];
                } else {
                    receivedData.push(value);
                    const progress = (receivedData.length / fileSize * 100).toFixed(1);
                    document.getElementById('progress').value = progress;
                    
                    if (receivedData.length === fileSize) {
                        saveFile(receivedData);
                    }
                }
            });

            fileCharacteristic.startNotifications();
        }

        function saveFile(dataChunks) {
            const blob = new Blob(dataChunks);
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `received_${Date.now()}`;
            link.textContent = '下载接收文件';
            
            document.getElementById('receivedFiles').appendChild(link);
        }

        function updateStatus(message) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = device?.gatt.connected ? 'connected' : 'disconnected';
        }
    </script>
</body>
</html>