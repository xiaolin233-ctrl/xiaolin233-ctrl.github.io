<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>专业图片处理器</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary-color: #007bff;
            --hover-color: #0056b3;
        }

        body {
            margin: 0;
            padding: 15px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f8f9fa;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        #previewCanvas {
            width: 100%;
            max-width: 600px;
            height: auto;
            margin: 15px 0;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            image-rendering: -webkit-optimize-contrast;
        }

        .control-group {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .slider-container {
            margin: 12px 0;
            display: grid;
            grid-template-columns: 80px 1fr 70px;
            align-items: center;
            gap: 10px;
        }

        .filter-btns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 8px;
        }

        .filter-btn {
            padding: 8px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .filter-btn:hover {
            border-color: var(--primary-color);
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: background 0.2s;
        }

        input[type="range"]:active::-webkit-slider-thumb {
            background: var(--hover-color);
        }

        #saveBtn {
            display: block;
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        #saveBtn:active {
            background: var(--hover-color);
        }

        @media (max-width: 768px) {
            .slider-container {
                grid-template-columns: 60px 1fr 50px;
            }
            
            .filter-btn {
                font-size: 13px;
                padding: 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>专业图片处理器</h1>
        
        <input type="file" id="upload" accept="image/*" style="margin-bottom:15px">
        <canvas id="previewCanvas"></canvas>
        
        <div class="control-group">
            <h3>基础调节</h3>
            <div class="slider-container">
                <label>亮度</label>
                <input type="range" id="brightness" min="0" max="200" value="100">
                <span class="value-display">100%</span>
            </div>
            <div class="slider-container">
                <label>对比度</label>
                <input type="range" id="contrast" min="0" max="200" value="100">
                <span class="value-display">100%</span>
            </div>
            <div class="slider-container">
                <label>饱和度</label>
                <input type="range" id="saturation" min="0" max="200" value="100">
                <span class="value-display">100%</span>
            </div>
        </div>

        <div class="control-group">
            <h3>高级调节</h3>
            <div class="slider-container">
                <label>色相</label>
                <input type="range" id="hue" min="0" max="360" value="0">
                <span class="value-display">0°</span>
            </div>
            <div class="slider-container">
                <label>锐化</label>
                <input type="range" id="sharpen" min="0" max="200" value="100">
                <span class="value-display">100%</span>
            </div>
            <div class="slider-container">
                <label>高光</label>
                <input type="range" id="highlight" min="0" max="200" value="100">
                <span class="value-display">100%</span>
            </div>
            <div class="slider-container">
                <label>阴影</label>
                <input type="range" id="shadow" min="0" max="200" value="100">
                <span class="value-display">100%</span>
            </div>
            <div class="slider-container">
                <label>清晰度</label>
                <input type="range" id="clarity" min="0" max="200" value="100">
                <span class="value-display">100%</span>
            </div>
            <div class="slider-container">
                <label>噪点</label>
                <input type="range" id="noise" min="0" max="100" value="0">
                <span class="value-display">0%</span>
            </div>
            <div class="slider-container">
                <label>色温</label>
                <input type="range" id="temperature" min="-100" max="100" value="0">
                <span class="value-display">0</span>
            </div>
        </div>

        <div class="control-group">
            <h3>专业滤镜</h3>
            <div class="filter-btns">
                <button class="filter-btn" data-filter="leicaVivid">徕卡鲜艳</button>
                <button class="filter-btn" data-filter="filmGrain">胶片颗粒</button>
                <button class="filter-btn" data-filter="cinematic">电影色调</button>
                <button class="filter-btn" data-filter="vintage">复古棕调</button>
                <button class="filter-btn" data-filter="monochrome">黑白经典</button>
                <button class="filter-btn" data-filter="japaneseStyle">日系小清新</button>
                <button class="filter-btn" data-filter="softFocus">美肤柔焦</button>
                <button class="filter-btn" data-filter="cyberpunk">赛博朋克</button>
                <button class="filter-btn" data-filter="vintageFilm">怀旧胶片</button>
                <button class="filter-btn" data-filter="midnightBlue">深蓝夜景</button>
                <button class="filter-btn" data-filter="sweetCandy">甜美糖果</button>
                <button class="filter-btn" data-filter="reset">重置效果</button>
            </div>
        </div>

        <button id="saveBtn">保存图片</button>
    </div>

    <script>
        const config = {
            maxSize: 2048,
            quality: 0.8,
            throttleDelay: 100
        };

        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        let sourceImage = null;
        let isProcessing = false;

        const controls = {
            brightness: getControlConfig('brightness', 100),
            contrast: getControlConfig('contrast', 100),
            saturation: getControlConfig('saturation', 100),
            hue: getControlConfig('hue', 0),
            sharpen: getControlConfig('sharpen', 100),
            highlight: getControlConfig('highlight', 100),
            shadow: getControlConfig('shadow', 100),
            clarity: getControlConfig('clarity', 100),
            noise: getControlConfig('noise', 0),
            temperature: getControlConfig('temperature', 0)
        };

        const presets = {
            leicaVivid: { contrast: 130, saturation: 140, sharpen: 120, highlight: 110 },
            filmGrain: { contrast: 110, saturation: 90, sharpen: 130, shadow: 85, noise: 20 },
            cinematic: { brightness: 90, contrast: 120, saturation: 110, hue: 350, temperature: 30 },
            vintage: { contrast: 115, saturation: 85, hue: 30, shadow: 90, clarity: 110 },
            monochrome: { saturation: 0, contrast: 110, sharpen: 120 },
            japaneseStyle: { brightness: 110, contrast: 95, saturation: 105, sharpen: 110, temperature: -20 },
            softFocus: { contrast: 90, saturation: 85, sharpen: 80, highlight: 110, clarity: 80 },
            cyberpunk: { hue: 200, saturation: 150, contrast: 130, brightness: 90, temperature: 50 },
            vintageFilm: { brightness: 105, contrast: 110, saturation: 85, hue: 25, noise: 30 },
            midnightBlue: { hue: 220, saturation: 130, brightness: 85, contrast: 115, temperature: -40 },
            sweetCandy: { saturation: 160, brightness: 105, hue: 340, sharpen: 110, clarity: 120 }
        };

        function init() {
            initEventListeners();
            initControls();
        }

        function initEventListeners() {
            document.getElementById('upload').addEventListener('change', handleFileUpload);
            
            Object.values(controls).forEach(control => {
                control.element.addEventListener('input', throttle(() => {
                    updateControlValue(control);
                    applyFilters();
                }, config.throttleDelay));
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => handleFilterClick(btn));
            });

            document.getElementById('saveBtn').addEventListener('click', saveImage);
        }

        function initControls() {
            Object.values(controls).forEach(updateDisplay);
        }

        async function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const img = await loadImage(file);
                sourceImage = img;
                canvas.width = img.width;
                canvas.height = img.height;
                applyFilters();
            } catch (error) {
                alert('图片加载失败: ' + error.message);
            }
        }

        function applyFilters() {
            if (!sourceImage || isProcessing) return;
            isProcessing = true;

            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(sourceImage, 0, 0);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            applyAdjustments(data);
            applySharpen(data, imageData.width, imageData.height);
            applyClarity(data, imageData.width, imageData.height);
            applyTemperature(data);
            addNoise(data);

            ctx.putImageData(imageData, 0, 0);
            isProcessing = false;
        }

        function applyAdjustments(data) {
            const brightness = (controls.brightness.value - 100) * 2.55;
            const contrast = controls.contrast.value / 100;
            const contrastIntercept = 128 * (1 - contrast);
            const saturation = controls.saturation.value / 100;
            const hue = controls.hue.value * Math.PI / 180;
            const cos = Math.cos(hue);
            const sin = Math.sin(hue);
            const highlight = controls.highlight.value / 100;
            const shadow = controls.shadow.value / 100;

            for (let i = 0; i < data.length; i += 4) {
                data[i] += brightness;
                data[i+1] += brightness;
                data[i+2] += brightness;

                data[i] = data[i] * contrast + contrastIntercept;
                data[i+1] = data[i+1] * contrast + contrastIntercept;
                data[i+2] = data[i+2] * contrast + contrastIntercept;

                const gray = 0.2989 * data[i] + 0.5870 * data[i+1] + 0.1140 * data[i+2];
                data[i] = gray + (data[i] - gray) * saturation;
                data[i+1] = gray + (data[i+1] - gray) * saturation;
                data[i+2] = gray + (data[i+2] - gray) * saturation;

                const r = data[i], g = data[i+1], b = data[i+2];
                data[i] = r * (cos + (1 - cos)/3) + g * ((1 - cos)/3 - Math.sqrt(1/3)*sin) + b * ((1 - cos)/3 + Math.sqrt(1/3)*sin);
                data[i+1] = r * ((1 - cos)/3 + Math.sqrt(1/3)*sin) + g * (cos + (1 - cos)/3) + b * ((1 - cos)/3 - Math.sqrt(1/3)*sin);
                data[i+2] = r * ((1 - cos)/3 - Math.sqrt(1/3)*sin) + g * ((1 - cos)/3 + Math.sqrt(1/3)*sin) + b * (cos + (1 - cos)/3);

                const luminance = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                if (luminance > 160) {
                    data[i] *= highlight;
                    data[i+1] *= highlight;
                    data[i+2] *= highlight;
                } else if (luminance < 96) {
                    data[i] *= shadow;
                    data[i+1] *= shadow;
                    data[i+2] *= shadow;
                }

                clampColors(data, i);
            }
        }

        function applySharpen(data, width, height) {
            if (width < 3 || height < 3) return;
            const intensity = (controls.sharpen.value - 100) / 50;
            if (intensity === 0) return;

            const kernel = [0, -intensity, 0, -intensity, 1 + 4*intensity, -intensity, 0, -intensity, 0];
            const tempData = new Uint8ClampedArray(data);

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                sum += tempData[idx] * kernel[(ky + 1) * 3 + (kx + 1)];
                            }
                        }
                        const idx = (y * width + x) * 4 + c;
                        data[idx] = Math.min(255, Math.max(0, sum));
                    }
                }
            }
        }

        function applyClarity(data, width, height) {
            if (width < 3 || height < 3) return;
            const intensity = Math.min(1.5, (controls.clarity.value - 100) / 50);
            if (intensity === 0) return;

            const kernel = [-intensity, -intensity, -intensity, -intensity, 1 + 8*intensity, -intensity, -intensity, -intensity, -intensity];
            const tempData = new Uint8ClampedArray(data);

            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const idx = ((y + ky) * width + (x + kx)) * 4 + c;
                                sum += tempData[idx] * kernel[(ky + 1) * 3 + (kx + 1)];
                            }
                        }
                        const idx = (y * width + x) * 4 + c;
                        data[idx] = Math.min(255, Math.max(0, sum));
                    }
                }
            }
        }

        function applyTemperature(data) {
            const value = controls.temperature.value;
            for (let i = 0; i < data.length; i += 4) {
                if (value > 0) {
                    data[i] *= 1 - value/100;
                    data[i+2] *= 1 + value/100;
                } else {
                    data[i] *= 1 + Math.abs(value)/100;
                    data[i+2] *= 1 - Math.abs(value)/100;
                }
                clampColors(data, i);
            }
        }

        function addNoise(data) {
            const intensity = controls.noise.value / 100;
            for (let i = 0; i < data.length; i += 4) {
                const noise = (Math.random() - 0.5) * 100 * intensity;
                data[i] += noise;
                data[i+1] += noise;
                data[i+2] += noise;
                clampColors(data, i);
            }
        }

        function handleFilterClick(btn) {
            const filterName = btn.dataset.filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            
            if (filterName === 'reset') {
                resetControls();
            } else {
                applyPreset(filterName);
                btn.classList.add('active');
            }
            applyFilters();
        }

        function applyPreset(presetName) {
            const preset = presets[presetName];
            Object.entries(preset).forEach(([key, value]) => {
                if (controls[key]) {
                    controls[key].element.value = value;
                    controls[key].value = value;
                    updateDisplay(controls[key]);
                }
            });
        }

        function resetControls() {
            Object.values(controls).forEach(control => {
                let defaultValue;
                switch (control.element.id) {
                    case 'hue': defaultValue = 0; break;
                    case 'temperature':
                    case 'noise': defaultValue = 0; break;
                    default: defaultValue = 100;
                }
                control.element.value = defaultValue;
                control.value = defaultValue;
                updateDisplay(control);
            });
        }

        // 辅助函数
        function getControlConfig(id, defaultValue) {
            return {
                element: document.getElementById(id),
                display: document.querySelector(`#${id} + .value-display`),
                value: defaultValue
            };
        }

        function updateControlValue(control) {
            control.value = parseInt(control.element.value);
            updateDisplay(control);
        }

        function updateDisplay(control) {
            control.display.textContent = 
                control.element.id === 'hue' ? `${control.value}°` : 
                control.element.id === 'temperature' ? control.value :
                `${control.value}%`;
        }

        function clampColors(data, i) {
            data[i] = Math.min(255, Math.max(0, data[i]));
            data[i+1] = Math.min(255, Math.max(0, data[i+1]));
            data[i+2] = Math.min(255, Math.max(0, data[i+2]));
        }

        function loadImage(file) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = () => reject(new Error('图片加载失败'));
                img.src = URL.createObjectURL(file);
            });
        }

        function throttle(fn, delay) {
            let lastCall = 0;
            return (...args) => {
                const now = Date.now();
                if (now - lastCall >= delay) {
                    lastCall = now;
                    fn(...args);
                }
            };
        }

        function saveImage() {
            if (!sourceImage) return;
            
            const link = document.createElement('a');
            link.download = `processed_${Date.now()}.jpg`;
            canvas.toBlob(blob => {
                link.href = URL.createObjectURL(blob);
                link.click();
            }, 'image/jpeg', config.quality);
        }

        // 初始化
        init();
    </script>
</body>
</html>