<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>高级图片处理器</title>
    <style>
        body {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        #previewCanvas {
            max-width: 100%;
            margin: 20px 0;
            border: 2px solid #ddd;
        }

        .control-group {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
        }

        .slider-container {
            margin: 10px 0;
        }

        .filter-btn {
            margin: 5px;
            padding: 8px 15px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
        }

        .filter-btn.active {
            background: #007bff;
            color: white;
            border-color: #0062cc;
        }

        input[type="range"] {
            width: 200px;
            vertical-align: middle;
        }

        .value-display {
            display: inline-block;
            width: 60px;
            text-align: right;
        }

        #saveBtn {
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>高级图片处理器</h1>
    
    <input type="file" id="upload" accept="image/*">
    <canvas id="previewCanvas"></canvas>
    
    <div class="control-group">
        <h3>调节类</h3>
        <div class="slider-container">
            亮度: <input type="range" id="brightness" min="0" max="200" value="100">
            <span class="value-display">100%</span>
        </div>
        <div class="slider-container">
            对比度: <input type="range" id="contrast" min="0" max="200" value="100">
            <span class="value-display">100%</span>
        </div>
        <div class="slider-container">
            饱和度: <input type="range" id="saturation" min="0" max="200" value="100">
            <span class="value-display">100%</span>
        </div>
        <div class="slider-container">
            色相: <input type="range" id="hue" min="0" max="360" value="0">
            <span class="value-display">0°</span>
        </div>
        <div class="slider-container">
            曝光: <input type="range" id="exposure" min="0" max="200" value="100">
            <span class="value-display">100%</span>
        </div>
        <div class="slider-container">
            高光: <input type="range" id="highlight" min="0" max="200" value="100">
            <span class="value-display">100%</span>
        </div>
        <div class="slider-container">
            阴影: <input type="range" id="shadow" min="0" max="200" value="100">
            <span class="value-display">100%</span>
        </div>
    </div>

    <div class="control-group">
        <h3>滤镜类</h3>
        <button class="filter-btn" data-filter="vintage">怀旧棕</button>
        <button class="filter-btn" data-filter="grayscale">黑白</button>
        <button class="filter-btn" data-filter="cold">冷色调</button>
        <button class="filter-btn" data-filter="warm">暖色调</button>
        <button class="filter-btn" data-filter="invert">反色</button>
        <button class="filter-btn" data-filter="dramatic">戏剧效果</button>
        <button class="filter-btn" data-filter="cinematic">电影感</button>
        <button class="filter-btn" data-filter="reset">重置</button>
    </div>

    <button id="saveBtn">保存图片</button>

    <script>
        const canvas = document.getElementById('previewCanvas');
        const ctx = canvas.getContext('2d');
        let originalImageData = null;
        let backupImage = null;
        
        // 初始化控件
        const controls = {
            brightness: { element: document.getElementById('brightness'), display: document.querySelector('#brightness + .value-display') },
            contrast: { element: document.getElementById('contrast'), display: document.querySelector('#contrast + .value-display') },
            saturation: { element: document.getElementById('saturation'), display: document.querySelector('#saturation + .value-display') },
            hue: { element: document.getElementById('hue'), display: document.querySelector('#hue + .value-display') },
            exposure: { element: document.getElementById('exposure'), display: document.querySelector('#exposure + .value-display') },
            highlight: { element: document.getElementById('highlight'), display: document.querySelector('#highlight + .value-display') },
            shadow: { element: document.getElementById('shadow'), display: document.querySelector('#shadow + .value-display') }
        };

        // 图片上传处理
        document.getElementById('upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            
            reader.onload = function(event) {
                backupImage = new Image();
                backupImage.onload = () => {
                    canvas.width = backupImage.width;
                    canvas.height = backupImage.height;
                    ctx.drawImage(backupImage, 0, 0);
                    originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                };
                backupImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // 绑定控件事件
        Object.entries(controls).forEach(([key, control]) => {
            control.element.addEventListener('input', function() {
                control.display.textContent = key === 'hue' ? `${this.value}°` : `${this.value}%`;
                applyFilters();
            });
        });

        // 滤镜处理
        const filterPresets = {
            vintage: { brightness: 110, contrast: 120, saturation: 80, hue: 30 },
            grayscale: { saturation: 0 },
            cold: { hue: 200, saturation: 120 },
            warm: { hue: 40, saturation: 150 },
            invert: () => applyInvertFilter(),
            dramatic: { contrast: 150, saturation: 130, shadow: 80 },
            cinematic: { brightness: 90, contrast: 130, saturation: 110 },
            reset: () => {
                Object.entries(controls).forEach(([key, control]) => {
                    const defaultValue = key === 'hue' ? 0 : 100;
                    control.element.value = defaultValue;
                    control.display.textContent = key === 'hue' ? `${defaultValue}°` : `${defaultValue}%`;
                });
                
                if (backupImage) {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.drawImage(backupImage, 0, 0);
                    originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                }
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            }
        };

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filter = this.dataset.filter;
                if (filterPresets[filter]) {
                    if (typeof filterPresets[filter] === 'function') {
                        filterPresets[filter]();
                    } else {
                        Object.entries(filterPresets[filter]).forEach(([key, value]) => {
                            if (controls[key]) {
                                controls[key].element.value = value;
                                controls[key].element.dispatchEvent(new Event('input'));
                            }
                        });
                    }
                }
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // 保存功能
        document.getElementById('saveBtn').addEventListener('click', function() {
            const link = document.createElement('a');
            link.download = 'processed-image.png';
            link.href = canvas.toDataURL();
            link.click();
        });

        // 图像处理函数
        function applyFilters() {
            if (!originalImageData || !backupImage) return;

            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(backupImage, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            applyAdjustment(data, 'brightness', parseInt(controls.brightness.element.value));
            applyAdjustment(data, 'contrast', parseInt(controls.contrast.element.value));
            applyAdjustment(data, 'saturation', parseInt(controls.saturation.element.value));
            applyAdjustment(data, 'hue', parseInt(controls.hue.element.value));
            applyAdjustment(data, 'exposure', parseInt(controls.exposure.element.value));
            applyHighlightShadow(data, 
                parseInt(controls.highlight.element.value),
                parseInt(controls.shadow.element.value)
            );

            ctx.putImageData(imageData, 0, 0);
        }

        function applyAdjustment(data, type, value) {
            switch(type) {
                case 'brightness':
                    const brightness = (value - 100) * 2.55;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] += brightness;
                        data[i+1] += brightness;
                        data[i+2] += brightness;
                    }
                    break;
                    
                case 'contrast':
                    const contrast = value / 100;
                    const intercept = 128 * (1 - contrast);
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = data[i] * contrast + intercept;
                        data[i+1] = data[i+1] * contrast + intercept;
                        data[i+2] = data[i+2] * contrast + intercept;
                    }
                    break;
                    
                case 'saturation':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i], g = data[i+1], b = data[i+2];
                        const gray = 0.2989 * r + 0.5870 * g + 0.1140 * b;
                        data[i] = gray + (r - gray) * (value / 100);
                        data[i+1] = gray + (g - gray) * (value / 100);
                        data[i+2] = gray + (b - gray) * (value / 100);
                    }
                    break;
                    
                case 'hue':
                    const hue = value * Math.PI / 180;
                    const cos = Math.cos(hue);
                    const sin = Math.sin(hue);
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i+1];
                        const b = data[i+2];
                        
                        data[i] = r * (cos + (1 - cos)/3) + g * ((1 - cos)/3 - Math.sqrt(1/3)*sin) + b * ((1 - cos)/3 + Math.sqrt(1/3)*sin);
                        data[i+1] = r * ((1 - cos)/3 + Math.sqrt(1/3)*sin) + g * (cos + (1 - cos)/3) + b * ((1 - cos)/3 - Math.sqrt(1/3)*sin);
                        data[i+2] = r * ((1 - cos)/3 - Math.sqrt(1/3)*sin) + g * ((1 - cos)/3 + Math.sqrt(1/3)*sin) + b * (cos + (1 - cos)/3);
                    }
                    break;
                    
                case 'exposure':
                    const exposure = value / 100;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] *= exposure;
                        data[i+1] *= exposure;
                        data[i+2] *= exposure;
                    }
                    break;
            }
            clampColors(data);
        }

        function applyHighlightShadow(data, highlight, shadow) {
            const highlightFactor = highlight / 100;
            const shadowFactor = shadow / 100;
            
            for (let i = 0; i < data.length; i += 4) {
                const luminance = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
                
                if (luminance > 160) {
                    data[i] *= highlightFactor;
                    data[i+1] *= highlightFactor;
                    data[i+2] *= highlightFactor;
                } else if (luminance < 96) {
                    data[i] *= shadowFactor;
                    data[i+1] *= shadowFactor;
                    data[i+2] *= shadowFactor;
                }
            }
            clampColors(data);
        }

        function clampColors(data) {
            for (let i = 0; i < data.length; i++) {
                data[i] = Math.min(255, Math.max(0, data[i]));
            }
        }

        function applyInvertFilter() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            
            tempCtx.drawImage(canvas, 0, 0);
            tempCtx.globalCompositeOperation = 'difference';
            tempCtx.fillStyle = 'white';
            tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            
            ctx.globalCompositeOperation = 'source-over';
            ctx.drawImage(tempCanvas, 0, 0);
        }
    </script>
</body>
</html>
