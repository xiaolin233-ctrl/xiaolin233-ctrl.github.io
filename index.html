<!DOCTYPE html>
<html>
<head>
    <title>蓝牙文件传输</title>
    <style>
        .container { max-width: 600px; margin: 20px auto; padding: 20px; }
        .status { margin: 10px 0; padding: 10px; background: #f0f0f0; }
        #progress { width: 100%; height: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>蓝牙文件传输</h1>
        
        <button id="connectBtn">连接设备</button>
        <button id="sendBtn" disabled>发送文件</button>
        <input type="file" id="fileInput" disabled>
        
        <div class="status">
            状态: <span id="status">等待连接...</span>
            <progress id="progress" value="0" max="100"></progress>
        </div>
    </div>

    <script>
        const SERVICE_UUID = '0000ff01-0000-1000-8000-00805f9b34fb';
        const CHARACTERISTIC_UUID = '0000ff02-0000-1000-8000-00805f9b34fb';

        let device;
        let characteristic;
        let fileChunks = [];
        let currentChunk = 0;
        const CHUNK_SIZE = 512; // 根据蓝牙MTU调整

        // 连接蓝牙设备
        document.getElementById('connectBtn').addEventListener('click', async () => {
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                
                enableUI();
                updateStatus("已连接");
                
                // 开始监听接收数据
                characteristic.startNotifications();
                characteristic.addEventListener('characteristicvaluechanged', handleReceivedData);
                
            } catch (error) {
                updateStatus(`连接失败: ${error}`);
            }
        });

        // 处理接收数据
        function handleReceivedData(event) {
            const value = event.target.value;
            const data = new TextDecoder().decode(value);
            
            if (data.startsWith('META:')) {
                const meta = JSON.parse(data.slice(5));
                fileChunks = new Array(Math.ceil(meta.size / CHUNK_SIZE));
                updateStatus(`接收文件: ${meta.name} (${meta.size}字节)`);
            } else if (data.startsWith('CHUNK:')) {
                const [index, chunk] = JSON.parse(data.slice(6));
                fileChunks[index] = chunk;
                currentChunk++;
                
                const progress = (currentChunk / fileChunks.length * 100).toFixed(1);
                document.getElementById('progress').value = progress;
                
                if (currentChunk === fileChunks.length) {
                    saveFile(fileChunks);
                    fileChunks = [];
                    currentChunk = 0;
                }
            }
        }

        // 发送文件
        document.getElementById('sendBtn').addEventListener('click', async () => {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return;

            try {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const buffer = e.target.result;
                    const chunks = [];
                    
                    // 发送元数据
                    const meta = {
                        name: file.name,
                        type: file.type,
                        size: file.size
                    };
                    await characteristic.writeValue(new TextEncoder().encode(`META:${JSON.stringify(meta)}`));

                    // 分块发送
                    for (let i = 0; i < file.size; i += CHUNK_SIZE) {
                        const chunk = buffer.slice(i, i + CHUNK_SIZE);
                        await characteristic.writeValue(
                            new TextEncoder().encode(`CHUNK:${JSON.stringify([chunks.length, chunk])}`)
                        );
                        document.getElementById('progress').value = (i / file.size * 100).toFixed(1);
                    }
                    
                    updateStatus("文件发送完成");
                };
                reader.readAsArrayBuffer(file);
                
            } catch (error) {
                updateStatus(`发送失败: ${error}`);
            }
        });

        // 保存接收的文件
        function saveFile(chunks) {
            const blob = new Blob(chunks, { type: 'application/octet-stream' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `received_${Date.now()}`;
            a.click();
            URL.revokeObjectURL(url);
            
            updateStatus("文件接收完成");
        }

        function enableUI() {
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('fileInput').disabled = false;
        }

        function updateStatus(text) {
            document.getElementById('status').textContent = text;
        }
    </script>
</body>
</html>